# arbell-php-test
Technical test done in May/June 2025

Created with
* [Symfony 7.3](https://symfony.com)
* [API Platform 4.1](https://api-platform.com)

Also used
* [MariaDB](https://mariadb.org)
* [Symfony Profiler](https://symfony.com/doc/current/profiler.html)
* [LexikJWTAuthenticationBundle](https://github.com/lexik/LexikJWTAuthenticationBundle) for JWT (JSON Web Token) authentication

## Branch
This is the `rest-api` branch, which contains a REST API for basic User CRUD operations.

## Composer packages
Run `composer install` to install all required packages

To generate the public and private keys used for signing JWT tokens, run `php bin/console lexik:jwt:generate-keypair`.

## Some technical details
* The project is done in Symfony to take advantage of their roles and permissions capabilities.
* Permissions are managed through the Profile entity. Each of them contains the `role` variable, that follows the `ROLE_[NAME]` convention used in Symfony. These are created using migrations. For more information about this, go to the `Test data` section.
* The database is MariaDB, the open source version of MySql. It is possible to switch to MySql, just update the url as explained later in this document.

### Database entity-relation diagram
![Diagram generated by phpMyAdmin](/screenshots/arbell-test%20-%20ERD.png)
Note: doctrine_migration_versions is an internal table used to keep track of executed migrations.

## Environment variables
All envirnoment variables are managed using a .env file.

This proyect comes with an example `.env`. Symfony allows `.env.[ENVIRONMENT_NAME]` files, to store variables of a specific environment.

In this case we need to set up before running the project for the first time
* `APP_ENV` to point which environment we are using. By default is set to `dev`.
* `DATABASE_URL` to connect with the MySql/MariaDB database. The value for MariaDB versions from 10.11.2 is `mysql://[USER]:[PASSWORD]@[DB_URL]:[DB_PORT]/[DB_NAME]?serverVersion=10.11.2-MariaDB&charset=utf8mb4` where
    * `USER` is a valid database engine user, with at least reading and writing permissions
    * `PASSWORD` is the user password
    * `DB_URL` is the url used by the database engine. For local environments, the default is `localhost`
    * `DB_PORT` is the port used by the database engine for listening. For local environment, the default is `3306`
    * `DB_NAME` is the database name

For MySql databases, use `DATABASE_URL="mysql://[USER]:[PASSWORD]@[DB_URL]:[DB_PORT]/[DB_NAME]`.

For older MariaDB versions or other databases, go to [Databases and the Doctrine ORM](https://symfony.com/doc/current/doctrine.html#configuring-the-database) in the official Symfony documentation.

* The following keys belong to the `lexik/jwt-authentication-bundle` package
    * `JWT_SECRET_KEY` defines the location of the secret key. Defaults to `%kernel.project_dir%/config/jwt/private.pem`.
    * `JWT_PUBLIC_KEY` defines the location of the public key. Defaults to `%kernel.project_dir%/config/jwt/public.pem`.
    * `JWT_PASSPHRASE` is required for token creation. This variable should be added automatically after generating the keys.

For more information about this package, go to its [official GitHub page](https://github.com/lexik/LexikJWTAuthenticationBundle).

## Test data
Run `php bin/console doctrine:database:create` to create an empty database. Note that this command will fail if the database user does not have creating permissions.

Run `php bin/console make:migrations:migrate` to create all the database tables and fill them with test data.

Test data consists of the two profiles, one with role `ROLE_ADMIN` and other with role `ROLE_USER`, and one user, `admin@example.com` with admin capabilities and password `test123`.

## Running locally
For local development, we can use the [Symfony binary](https://symfony.com/download) to run the local server.

Once the binary is installed, run `php bin/console asset-map:compile --no-debug` to compile all assets, followed by `symfony server:start`. If this last command does not work, check where the symfony binary is located. For Linux systems the default location is `$HOME/.symfony/bin`.

By default, the api is available at `http://localhost:8000/api`. If you enter this url in a browser you will be redirected to the OpenAPI documentation.

The root of the project contains a simple landing page.
![Landing](/screenshots/Landing.png)

### Note
If you get the following error after starting the server

    Error thrown while running command "asset-map:compile --no-debug". Message: "Unable to find asset "./path/to/domAnimations" imported from "[PROJECT_DIR]/vendor/api-platform/symfony/Bundle/Resources/public/graphiql/graphiql.min.js

This is a bug already documented in [Asset mapper warnings #6377 - api-platform/core](https://github.com/api-platform/core/issues/6377). There is a patch that should be applied successfully with composer. However, if you still get a blank screen or error message when trying to access the API docs, apply the patch in `patches/api-platform-6377-graphiql.patch` using git or remove the lines manually.

Run `composer install` to run all the post installation scripts, compile the assets once more with `php bin/console asset-map:compile --no-debug`, start the server again and then go to `http://localhost:8000/api` and check the docs load normally.

## User permissions
* The `/profiles` endpoint is unprotected and only allows GET requests.
* Only authenticated users can access the `/users` endpoint.
* To get authenticated, send a POST request to `/auth` with user and password in the body to get an authorization token. Check the examples section for more information.
* Only users with admin profile (`ROLE_ADMIN`) can send DELETE requests.

## Available operations
API Platform supports the OpenAPI specification format. Go to /docs.html to access the documentation.
Here is a quick overview of the available operations in this REST API.

![API documentation](/screenshots/API%20documentation.png)

## Examples (done with Imsomnia)
Requests available at `insomnia_api_requests.yml`

### Login (get authorization token)
![POST auth](/screenshots/Login%20request.png)

### Set authorization token
![Auth Bearer token](/screenshots/User%20auth%20config.png)

### Get all profiles
![GET all profiles](/screenshots/GET%20profiles%20request.png)

### Get all users
![GET all users](/screenshots/GET%20users%20request.png)

### Creation new user (with [Faker](https://github.com/FakerPHP/Faker))
![POST user](/screenshots/POST%20create%20new%20user%20with%20faker.png)

### Get one user in particular
![GET user](/screenshots/GET%20single%20user.png)

### Edit a specific user
![PATCH user](/screenshots/PATCH%20user.png)

### Edit a specific user - email validaton error
![PATCH user validation error](/screenshots/PATCH%20request%20error.png)

### Delete a specific user
![DELETE user](/screenshots/DELETE%20user%20ok.png)

### Authorization
#### Delete user - access denied for user with `ROLE_USER` profile
![DELETE user 403](/screenshots/DELETE%20user%20-%20access%20denied.png)

#### Get all users - access denied for unauthenticated user
![GET users 401](/screenshots/GET%20users%20request%20-%20not%20logged%20in.png)